name: Release Rulesfile
on:
  push:
    branches: [ main ]

jobs:
  release-rulesfile:
    runs-on: ubuntu-latest

    # These permissions are needed to interact with GitHub's OIDC Token endpoint.
    permissions:
      id-token: write
      contents: read
      packages: write

    env:
      RULES_FILE: falco_rules.yaml

      OCI_REGISTRY: ghcr.io
      ARTIFACT_NAME: falco-rules
      ARTIFACT_TAG: latest # or e.g. ${{ github.sha }}

    steps:

      # Get falcoctl
      - name: Checkout Falcoctl Repo
        uses: actions/checkout@v3
        with:
          repository: falcosecurity/falcoctl
          # It doesn't work with OIDC token authn to GHR. 
          #ref: v0.4.0
          ref: main
          path: falcoctl
      - name: Setup Golang
        uses: actions/setup-go@v4
        with:
          go-version-file: falcoctl/go.mod
          cache-dependency-path: falcoctl/go.sum
      - run: go version
      - name: Build falcoctl
        run: make
        working-directory: falcoctl
      - run: falcoctl/falcoctl version

      # Get the rules
      - name: Checkout Rules Repo
        uses: actions/checkout@v3
        with:
          path: rules

      # Upload the rules artifact with falcoctl
      - name: Upload OCI artifacts to GitHub packages
        run: |
             falcoctl/falcoctl registry push \
             --config /dev/null \
             --type rulesfile \
             --version ${ARTIFACT_TAG} \
             ${OCI_REGISTRY}/${{ github.repository }}/${ARTIFACT_NAME}:${ARTIFACT_TAG} \
             rules/rules/${RULES_FILE}             
        env:
          FALCOCTL_REGISTRY_AUTH_BASIC: ${{ env.OCI_REGISTRY }},${{ github.actor }},${{ secrets.GITHUB_TOKEN }}

      # Get the OCI artifact digest
      - name: Setup Crane
        uses: imjasonh/setup-crane@v0.1
      - run: crane version
      - name: Get the artifact digest
        id: get_artifact_digest
        run: >-
          echo "::set-output name=ARTIFACT_DIGEST::$(
            crane digest ${OCI_REGISTRY}/${{ github.repository }}/${ARTIFACT_NAME}:${ARTIFACT_TAG}
          )"

      # Create an signature of the rules artifact as OCI artifact
      - name: Install Cosign
        uses: sigstore/cosign-installer@main
        with:
          cosign-release: 'v2.0.2'
      - run: cosign version
      - name: Sign the images with GitHub OIDC Token
        env:
          # Add support for OCI v1.1
          COSIGN_EXPERIMENTAL: 1
          ARTIFACT_DIGEST: "${{ steps.get_artifact_digest.outputs.ARTIFACT_DIGEST }}"
        run: cosign sign --yes ${OCI_REGISTRY}/${{ github.repository }}/${ARTIFACT_NAME}@${ARTIFACT_DIGEST}

